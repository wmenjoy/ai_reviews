# AI代码审核平台 - 多视角分析功能补充

## Epic 11: 多维度审核分析

### 概述

提供**用户、部门、公司、规则**四个维度的代码审核分析，让不同角色能从各自关心的视角看数据，做出更好的决策。

---

## 11.1 用户视角（个人质量中心）

### Story 11.1.1: 作为开发者，我希望看到自己的代码质量画像

**优先级**: P1
**价值**: 让开发者了解自己的编码水平和成长轨迹

**场景描述**：
```
Given 我是一名开发者
When 我进入"我的质量中心"
Then 我能看到：
  - 我的质量总分（0-100）
  - 最近30天的质量趋势图
  - 我在团队中的排名
  - 我的强项和弱项分析
  - 我最常犯的错误
  - 改进建议
```

**验收标准**：
- [ ] 个人质量总分计算（加权平均）
- [ ] 30天趋势折线图
- [ ] 团队排名（可选隐藏）
- [ ] 雷达图展示多维能力
- [ ] Top问题统计
- [ ] 个性化建议

**页面设计**：
```
我的质量中心 - 张三
┌─────────────────────────────────────────────────────┐
│ 质量总分: 87/100 (↑ 比上月+5)                        │
│ ████████████████████░░ 优秀                          │
│ 团队排名: 12/45  超越73%的同事 🎉                    │
│                                                     │
│ 30天质量趋势:                                        │
│ 100│                            ●                   │
│  90│                    ●   ●       ●               │
│  80│        ●   ●   ●                   ●           │
│  70│    ●                                           │
│    └────────────────────────────────                │
│     1日  5   10  15  20  25  30                     │
│                                                     │
├─────────────────────────────────────────────────────┤
│ 能力雷达图:                                          │
│         安全性(90)                                   │
│            ╱│╲                                      │
│  代码质量(85) │ 性能(80)                            │
│            ╲│╱                                      │
│         规范性(88)                                   │
│                                                     │
├─────────────────────────────────────────────────────┤
│ 我的统计 (最近30天):                                 │
│                                                     │
│ 提交次数: 45次                                       │
│ 审核通过率: 93% (42/45)                              │
│ 平均得分: 87分                                       │
│ 发现问题: 23个 (严重0 错误3 警告20)                  │
│ 修复率: 95% (22/23)                                  │
│                                                     │
├─────────────────────────────────────────────────────┤
│ 我最常犯的错误 (Top 5):                              │
│                                                     │
│ 1. 方法过长 (8次) ████████                          │
│    建议: 遵循单一职责原则，拆分大方法                 │
│                                                     │
│ 2. 缺少异常处理 (5次) █████                         │
│    建议: 添加try-catch，处理可能的异常               │
│                                                     │
│ 3. 日志缺失 (4次) ████                              │
│    建议: 关键业务逻辑添加日志                        │
│                                                     │
│ 4. 变量命名不规范 (3次) ███                         │
│    建议: 使用有意义的变量名                          │
│                                                     │
│ 5. 魔法数字 (2次) ██                                │
│    建议: 定义常量替代硬编码                          │
│                                                     │
├─────────────────────────────────────────────────────┤
│ 💡 个性化建议:                                       │
│                                                     │
│ 1. 你在"安全性"方面表现优秀！继续保持 👍            │
│                                                     │
│ 2. "性能"相对较弱，建议学习：                        │
│    - Java性能优化最佳实践                            │
│    - 常见性能陷阱                                    │
│    [推荐课程: 《Java性能调优实战》]                  │
│                                                     │
│ 3. 本月改进最明显的是"代码质量"(+12分)              │
│    你在路上！keep going 💪                           │
│                                                     │
├─────────────────────────────────────────────────────┤
│ 成长轨迹:                                            │
│                                                     │
│ 🏆 2025-01: 首次代码审核得分90+                      │
│ 📈 2024-12: 月平均分提升10分                         │
│ 🎯 2024-11: 连续30天零CRITICAL问题                   │
│ ⭐ 2024-10: 成为团队质量前20%                        │
│                                                     │
│ [查看完整历史] [导出报告]                            │
└─────────────────────────────────────────────────────┘
```

---

### Story 11.1.2: 作为开发者，我希望看到我负责的项目的质量状况

**优先级**: P1

**场景描述**：
```
Given 我负责多个项目
When 我切换到"我的项目"视图
Then 我能看到：
  - 我参与的所有项目列表
  - 每个项目的质量得分
  - 每个项目中我的贡献占比
  - 项目质量趋势
```

**验收标准**：
- [ ] 项目列表（按参与度排序）
- [ ] 项目质量卡片
- [ ] 个人贡献统计
- [ ] 快速筛选（仅看我的提交）

---

### Story 11.1.3: 作为开发者，我希望和同事进行良性对比

**优先级**: P2
**价值**: 激励开发者提升代码质量

**场景描述**：
```
Given 团队启用了"质量排行榜"
When 我查看排行榜
Then 我能看到：
  - 本周/本月质量排行Top10
  - 进步最快排行
  - 各语言质量冠军
  - 我的排名变化
And 可以选择匿名显示（只看自己排名）
```

**验收标准**：
- [ ] 多维度排行榜（总分/安全/质量/性能）
- [ ] 进步榜（本月vs上月）
- [ ] 语言榜（Java冠军、Go冠军等）
- [ ] 隐私保护（可选匿名）
- [ ] 游戏化元素（徽章、成就）

**页面设计**：
```
质量排行榜 - 本月
┌─────────────────────────────────────────┐
│ 切换: [本周] [本月] [本季度]             │
├─────────────────────────────────────────┤
│ 🏆 综合质量榜                            │
│                                         │
│ 1. 🥇 李四     92分  ↑2                 │
│ 2. 🥈 王五     91分  ↓1                 │
│ 3. 🥉 张三     90分  →                  │
│ ...                                     │
│ 12. 😊 我      87分  ↑5 (进步很大!)    │
│                                         │
├─────────────────────────────────────────┤
│ 📈 进步最快榜                            │
│                                         │
│ 1. 赵六  +15分 (从72→87)               │
│ 2. 我    +12分 (从75→87) 🎉            │
│ 3. 孙七  +10分 (从80→90)               │
│                                         │
├─────────────────────────────────────────┤
│ 💻 语言质量冠军                          │
│                                         │
│ Java:   李四  95分                      │
│ Go:     王五  93分                      │
│ React:  张三  92分                      │
│ Python: 我    89分 🏅                   │
│                                         │
└─────────────────────────────────────────┘
```

---

## 11.2 部门视角（部门质量管理）

### Story 11.2.1: 作为部门经理，我希望看到部门整体质量状况

**优先级**: P1
**价值**: 帮助部门经理了解团队质量，制定改进计划

**场景描述**：
```
Given 我是部门经理
When 我进入"部门质量看板"
Then 我能看到：
  - 部门质量总分和趋势
  - 部门在公司中的排名
  - 团队成员质量分布
  - 项目质量排行
  - 高风险项目识别
  - 问题分布分析
```

**验收标准**：
- [ ] 部门质量总分（加权）
- [ ] 趋势分析（周/月/季度）
- [ ] 公司排名（与其他部门对比）
- [ ] 成员质量分布（正态分布图）
- [ ] 项目健康度雷达
- [ ] 预警机制（质量下降告警）

**页面设计**：
```
后端研发部 - 质量看板
┌──────────────────────────────────────────────────────┐
│ 部门质量总分: 85/100 (↑ 比上月+3)                     │
│ 公司排名: 2/8  领先大部分部门 🎯                      │
│                                                      │
│ 成员: 45人  项目: 12个  本月审核: 234次              │
│                                                      │
├──────────────────────────────────────────────────────┤
│ 质量趋势 (最近6个月):                                 │
│                                                      │
│ 90│                                ●                 │
│ 85│                    ●       ●       ●             │
│ 80│            ●   ●                                 │
│ 75│    ●                                             │
│   └──────────────────────────────                    │
│    1月  2月  3月  4月  5月  6月                       │
│                                                      │
│ 📊 分析: 质量持续上升，5月达到峰值                    │
│                                                      │
├──────────────────────────────────────────────────────┤
│ 成员质量分布:                                         │
│                                                      │
│   人数                                               │
│    12│         ███                                   │
│    10│     ███ ███ ███                               │
│     8│ ███ ███ ███ ███ ██                            │
│       └─────────────────────                         │
│       <60 60-70 70-80 80-90 >90                      │
│                                                      │
│ 优秀(>85): 28人 (62%)                                │
│ 良好(70-85): 15人 (33%)                              │
│ 需改进(<70): 2人 (4%) ⚠️                              │
│                                                      │
├──────────────────────────────────────────────────────┤
│ 项目质量排行:                                         │
│                                                      │
│ 1. user-service        92分  ✅ 健康                 │
│ 2. order-service       89分  ✅ 健康                 │
│ 3. payment-service     87分  ✅ 健康                 │
│ ...                                                  │
│ 10. legacy-system      65分  ⚠️ 需关注               │
│ 11. old-api            58分  🚨 高风险               │
│                                                      │
│ [查看完整列表]                                        │
│                                                      │
├──────────────────────────────────────────────────────┤
│ 问题分布 (本月):                                      │
│                                                      │
│ 安全问题: 15个 (↓ -5)  ██████                        │
│ 质量问题: 67个 (↑ +12) ████████████████              │
│ 性能问题: 23个 (→ 0)   ████████                      │
│ 风格问题: 145个        ████████████████████████      │
│                                                      │
│ 💡 建议: 质量问题上升，建议组织代码质量培训           │
│                                                      │
├──────────────────────────────────────────────────────┤
│ 🚨 需要关注的项目:                                    │
│                                                      │
│ 1. old-api (58分)                                    │
│    问题: 技术债务严重，安全问题较多                   │
│    建议: 安排重构计划                                 │
│    负责人: 张三                                       │
│                                                      │
│ 2. legacy-system (65分)                              │
│    问题: 代码质量波动大                               │
│    建议: 加强Code Review                              │
│    负责人: 李四                                       │
│                                                      │
├──────────────────────────────────────────────────────┤
│ 团队对比 (与其他部门):                                │
│                                                      │
│ 后端部    ████████████████████ 85分  (我们)          │
│ 前端部    █████████████████ 82分                     │
│ 算法部    ██████████████████ 83分                    │
│ 客户端部  ███████████████ 78分                       │
│                                                      │
│ [查看详细对比]                                        │
└──────────────────────────────────────────────────────┘
```

---

### Story 11.2.2: 作为部门经理，我希望能深入分析团队成员的质量数据

**优先级**: P1

**场景描述**：
```
Given 我需要了解团队成员的质量状况
When 我查看"成员质量详情"
Then 我能看到：
  - 每个成员的质量分数
  - 成员的强项和弱项
  - 成员的进步趋势
  - 需要帮助的成员识别
  - 优秀实践者识别
```

**验收标准**：
- [ ] 成员列表（可排序）
- [ ] 成员详情卡片
- [ ] 成员对比功能
- [ ] 导出Excel报告
- [ ] 一对一谈话建议

**页面设计**：
```
团队成员质量分析
┌─────────────────────────────────────────┐
│ 筛选: [全部▼] [优秀] [良好] [需改进]    │
│ 排序: [综合得分▼]                        │
├─────────────────────────────────────────┤
│                                         │
│ ┌─ 张三 ────────────────────────┐      │
│ │ 综合得分: 92分 (团队第3名)      │      │
│ │ 本月提交: 15次  通过率: 100%   │      │
│ │                                │      │
│ │ 强项: 安全性(95) 性能(93)      │      │
│ │ 弱项: 规范性(85)               │      │
│ │                                │      │
│ │ 趋势: ↗️ 持续上升               │      │
│ │ 标签: 🌟优秀实践者             │      │
│ │                                │      │
│ │ [查看详情] [一对一建议]        │      │
│ └────────────────────────────────┘      │
│                                         │
│ ┌─ 李四 ────────────────────────┐      │
│ │ 综合得分: 68分 (↓ -8)          │      │
│ │ 本月提交: 8次  通过率: 75%     │      │
│ │                                │      │
│ │ 强项: 性能(80)                 │      │
│ │ 弱项: 安全性(55) ⚠️             │      │
│ │                                │      │
│ │ 趋势: ↘️ 需要关注               │      │
│ │ 标签: 🚨需要帮助               │      │
│ │                                │      │
│ │ 💡 建议行动:                   │      │
│ │ - 安排安全编码培训             │      │
│ │ - 一对一Code Review            │      │
│ │ - 分配安全专家导师             │      │
│ │                                │      │
│ │ [制定改进计划]                 │      │
│ └────────────────────────────────┘      │
│                                         │
│ [导出团队报告.xlsx]                     │
└─────────────────────────────────────────┘
```

---

### Story 11.2.3: 作为部门经理，我希望能识别团队的技能短板

**优先级**: P2

**场景描述**：
```
Given 部门有多个项目和多种技术栈
When 我查看"技能分析"
Then 我能看到：
  - 团队在各个维度的平均分
  - 相比其他部门的差距
  - 需要加强的技能
  - 培训建议
```

**验收标准**：
- [ ] 技能雷达图（团队平均）
- [ ] 部门对比
- [ ] 技能矩阵（人员-技能）
- [ ] 培训计划建议

---

## 11.3 公司视角（全局质量管理）

### Story 11.3.1: 作为CTO，我希望看到全公司的代码质量全貌

**优先级**: P1
**价值**: 高层决策依据，了解整体技术健康度

**场景描述**：
```
Given 我是CTO/技术VP
When 我进入"全局质量看板"
Then 我能看到：
  - 公司整体质量得分和趋势
  - 各部门质量对比
  - 各语言质量对比
  - 高风险项目识别
  - 技术债务总览
  - 投入产出分析
```

**验收标准**：
- [ ] 公司质量总分（KPI级别）
- [ ] 部门对比雷达图
- [ ] 语言质量分布
- [ ] 风险项目列表（Top10）
- [ ] 技术债务趋势
- [ ] ROI分析（AI审核价值）

**页面设计**：
```
全局质量看板 - 某某科技
┌───────────────────────────────────────────────────────┐
│ 🏢 公司代码质量总览                                    │
│                                                       │
│ 整体质量得分: 83/100 (↑ +2 YoY)                       │
│ ████████████████████████░░ 良好                       │
│                                                       │
│ 总项目数: 156个  总代码量: 500万行  开发者: 380人    │
│                                                       │
├───────────────────────────────────────────────────────┤
│ 📊 质量趋势 (最近12个月):                             │
│                                                       │
│ 90│                                        ●          │
│ 85│                            ●       ●              │
│ 80│        ●       ●       ●                          │
│ 75│    ●       ●                                      │
│   └──────────────────────────────────                 │
│    1月 2月 3月 4月 5月 6月 7月 8月 9月 10月 11月 12月  │
│                                                       │
│ 📈 年度改善: +8分  目标达成率: 80%                    │
│                                                       │
├───────────────────────────────────────────────────────┤
│ 🏆 部门质量对比:                                      │
│                                                       │
│ 后端研发部  ████████████████████ 85分  ↑              │
│ 算法部      ███████████████████ 83分   ↑              │
│ 前端研发部  ██████████████████ 82分    →              │
│ 数据部      █████████████████ 80分     →              │
│ 测试部      ████████████████ 78分      ↓              │
│ 客户端部    ███████████████ 76分       ↓              │
│ 运维部      ██████████████ 72分        ↓ ⚠️           │
│ 外包团队    ████████ 58分              → 🚨           │
│                                                       │
│ 💡 发现: 外包团队质量明显偏低，建议加强管理           │
│                                                       │
├───────────────────────────────────────────────────────┤
│ 💻 语言质量分布:                                      │
│                                                       │
│ Go         ████████████████████ 88分  (35个项目)     │
│ Java       ██████████████████ 82分    (45个项目)     │
│ TypeScript █████████████████ 80分     (28个项目)     │
│ Python     ████████████████ 78分      (22个项目)     │
│ C++        ███████████ 65分           (15个项目) ⚠️   │
│ C          ████████ 58分              (11个项目) 🚨   │
│                                                       │
│ 💡 建议: C/C++项目质量偏低，建议引入专项培训         │
│                                                       │
├───────────────────────────────────────────────────────┤
│ 🚨 高风险项目 (Top 10):                               │
│                                                       │
│ Rank  项目名          部门    得分  风险等级          │
│ 1.    legacy-billing  财务部  45分  🔴 极高          │
│ 2.    old-crm         销售部  52分  🔴 极高          │
│ 3.    payment-v1      后端部  58分  🟡 高            │
│ 4.    mobile-app-old  客户端  62分  🟡 高            │
│ ...                                                   │
│                                                       │
│ [查看完整列表] [生成整改计划]                         │
│                                                       │
├───────────────────────────────────────────────────────┤
│ 💰 技术债务总览:                                      │
│                                                       │
│ 总债务: 12,456个问题                                  │
│ ├─ 严重: 234个 (↓ -45) ✅                            │
│ ├─ 错误: 1,890个 (↑ +120) ⚠️                         │
│ └─ 警告: 10,332个                                     │
│                                                       │
│ 债务趋势: ↘️ 总体下降中 (-15% YoY)                    │
│                                                       │
│ 预计修复成本: 约2,400人天                             │
│ 建议优先级: 先处理234个严重问题                       │
│                                                       │
├───────────────────────────────────────────────────────┤
│ 📈 AI审核价值分析:                                    │
│                                                       │
│ 本月审核次数: 2,340次                                 │
│ 发现问题: 8,923个                                     │
│ 阻止严重问题: 234个 (💰 避免潜在损失: 约500万)       │
│                                                       │
│ 节省人工Review时间: 约1,200小时                       │
│ 按平均时薪300元计算: 节省成本 36万/月                │
│                                                       │
│ AI成本: 约2万/月                                      │
│ ROI: 1800% 🎉                                         │
│                                                       │
└───────────────────────────────────────────────────────┘
```

---

### Story 11.3.2: 作为CTO，我希望能追踪年度质量改进目标

**优先级**: P1

**场景描述**：
```
Given 公司设定了年度质量目标
  例如: 整体质量分提升到85分以上
When 我查看"目标追踪"
Then 我能看到：
  - 当前进度 vs 目标
  - 各部门达成情况
  - 风险预警
  - 改进建议
```

**验收标准**：
- [ ] 目标设定功能
- [ ] 进度追踪仪表盘
- [ ] 部门达成率
- [ ] 预测完成时间
- [ ] 风险识别

---

### Story 11.3.3: 作为高管，我希望能生成董事会级别的质量报告

**优先级**: P2

**场景描述**：
```
Given 需要向董事会汇报技术质量
When 我生成"高管报告"
Then 报告包含：
  - 核心指标卡片（质量分、债务量、改进幅度）
  - 趋势分析（同比、环比）
  - 重大风险和应对
  - 投入产出分析
  - 行业对标
```

**验收标准**：
- [ ] 一键生成PPT报告
- [ ] 数据可视化（图表）
- [ ] 关键发现和建议
- [ ] 支持自定义时间范围

---

## 11.4 规则视角（规则效能分析）

### Story 11.4.1: 作为平台管理员，我希望知道哪些规则最有价值

**优先级**: P1
**价值**: 优化规则库，去掉低效规则

**场景描述**：
```
Given 平台有100+条规则
When 我查看"规则效能分析"
Then 我能看到：
  - 每条规则的触发频率
  - 每条规则的误报率
  - 每条规则的修复率
  - 规则价值评分
  - 规则优化建议
```

**验收标准**：
- [ ] 规则触发统计
- [ ] 误报率计算（被标记为误报的比例）
- [ ] 修复率统计
- [ ] 价值评分公式（触发频率 × 严重程度 × 修复率 × (1-误报率)）
- [ ] 建议禁用的规则

**页面设计**：
```
规则效能分析
┌──────────────────────────────────────────────────────┐
│ 规则总数: 156条  启用: 142条  本月触发: 8,923次      │
├──────────────────────────────────────────────────────┤
│                                                      │
│ 🏆 最有价值规则 Top 10:                              │
│                                                      │
│ Rank  规则名              触发  误报率  价值分        │
│ 1.    SQL注入检测         234   2%     98.5         │
│ 2.    空指针风险          189   5%     95.2         │
│ 3.    资源未关闭          156   3%     94.8         │
│ 4.    并发安全            123   8%     91.3         │
│ 5.    XSS漏洞检测         89    4%     89.7         │
│ ...                                                  │
│                                                      │
│ 💡 这些规则发现了高价值问题，建议保留并推广         │
│                                                      │
├──────────────────────────────────────────────────────┤
│ ⚠️ 需要优化的规则:                                   │
│                                                      │
│ Rank  规则名              触发  误报率  建议          │
│ 1.    变量命名检查        567   45%    调整阈值      │
│ 2.    注释完整性          234   38%    优化Prompt    │
│ 3.    方法长度            189   32%    调整规则      │
│                                                      │
│ 💡 这些规则误报率高，建议优化或禁用                  │
│                                                      │
├──────────────────────────────────────────────────────┤
│ 📊 规则使用热力图:                                   │
│                                                      │
│ 分类          触发次数                               │
│ 安全问题      ████████████████ 2,345                 │
│ 质量问题      ████████████████████████ 3,678         │
│ 性能问题      ████████ 1,234                         │
│ 风格问题      ████ 666                               │
│                                                      │
├──────────────────────────────────────────────────────┤
│ 🔍 规则详细分析 - SQL注入检测:                       │
│                                                      │
│ 触发次数: 234次 (本月)                               │
│ 误报: 5次 (2.1%)                                     │
│ 修复: 221次 (94.4%)                                  │
│ 未修复: 8次 (已加入技术债务)                         │
│                                                      │
│ 发现项目分布:                                         │
│ - payment-service: 89次                              │
│ - order-service: 56次                                │
│ - user-service: 34次                                 │
│ ...                                                  │
│                                                      │
│ 典型问题示例:                                         │
│ ```java                                              │
│ String sql = "SELECT * FROM users WHERE id=" + id;   │
│ ```                                                  │
│                                                      │
│ 修复后代码:                                           │
│ ```java                                              │
│ String sql = "SELECT * FROM users WHERE id = ?";     │
│ PreparedStatement ps = conn.prepareStatement(sql);   │
│ ps.setInt(1, id);                                    │
│ ```                                                  │
│                                                      │
│ 价值评估:                                             │
│ - 阻止了234次潜在的SQL注入漏洞                       │
│ - 估算避免损失: 约1000万(假设10%漏洞被利用)          │
│                                                      │
└──────────────────────────────────────────────────────┘
```

---

### Story 11.4.2: 作为规则维护者，我希望能A/B测试新规则

**优先级**: P2

**场景描述**：
```
Given 我创建了一条新规则
When 我启用"A/B测试模式"
Then 新规则只对50%的审核生效
And 我能对比：
  - 新规则的触发率
  - 误报率
  - 开发者反馈
And 决定是否全量发布
```

**验收标准**：
- [ ] A/B测试开关
- [ ] 流量分配配置
- [ ] 对比报告
- [ ] 开发者反馈收集

---

### Story 11.4.3: 作为产品经理，我希望知道自定义规则的使用情况

**优先级**: P2

**场景描述**：
```
Given 团队创建了自定义规则
When 我查看"自定义规则分析"
Then 我能看到：
  - 哪些团队创建了规则
  - 自定义规则的质量
  - 规则复用情况
  - 优秀规则推荐
```

**验收标准**：
- [ ] 自定义规则列表
- [ ] 规则质量评分
- [ ] 复用次数统计
- [ ] 推荐到规则市场

---

## 11.5 对比分析（横向对比）

### Story 11.5.1: 作为管理者，我希望能对比不同维度的数据

**优先级**: P1

**场景描述**：
```
Given 我想了解不同维度的质量差异
When 我使用"对比分析"功能
Then 我能选择：
  - 部门对比（后端部 vs 前端部）
  - 项目对比（项目A vs 项目B）
  - 时间对比（本月 vs 上月）
  - 语言对比（Java vs Go）
And 看到直观的对比图表
```

**验收标准**：
- [ ] 灵活的对比维度选择
- [ ] 雷达图/柱状图对比
- [ ] 差异高亮
- [ ] 导出对比报告

---

## 11.6 数据导出和分享

### Story 11.6.1: 作为用户，我希望能导出和分享数据

**优先级**: P2

**场景描述**：
```
Given 我想分享数据给其他人
When 我点击"导出"或"分享"
Then 我能：
  - 导出Excel报告
  - 导出PDF报告
  - 生成分享链接（带权限控制）
  - 定期邮件订阅
```

**验收标准**：
- [ ] Excel导出（带图表）
- [ ] PDF导出（格式化）
- [ ] 分享链接（临时访问）
- [ ] 邮件订阅功能

---

## 数据模型补充

为支持多视角分析，需要增加以下数据结构：

```prisma
// 用户质量快照（每日计算）
model UserQualitySnapshot {
  id            String   @id @default(cuid())
  userId        String
  date          DateTime

  // 质量指标
  overallScore  Float    // 综合得分
  securityScore Float    // 安全性得分
  qualityScore  Float    // 质量得分
  performScore  Float    // 性能得分
  styleScore    Float    // 规范性得分

  // 统计指标
  reviewCount   Int      // 审核次数
  issueCount    Int      // 问题数
  fixedCount    Int      // 修复数

  // 排名
  rankInTeam    Int?     // 团队排名
  rankInDept    Int?     // 部门排名

  @@unique([userId, date])
  @@index([date])
}

// 部门质量快照（每日计算）
model DepartmentQualitySnapshot {
  id             String   @id @default(cuid())
  departmentId   String
  date           DateTime

  overallScore   Float
  memberCount    Int
  projectCount   Int
  reviewCount    Int

  // 分布
  scoreDistribution Json  // { "<60": 2, "60-70": 5, ... }

  rankInCompany  Int?

  @@unique([departmentId, date])
}

// 公司质量快照（每日计算）
model CompanyQualitySnapshot {
  id              String   @id @default(cuid())
  date            DateTime @unique

  overallScore    Float
  departmentCount Int
  memberCount     Int
  projectCount    Int

  // 语言分布
  languageScores  Json     // { "java": 82, "go": 88, ... }

  // 技术债务
  totalDebt       Int
  criticalDebt    Int

  createdAt       DateTime @default(now())
}

// 规则效能统计（每日计算）
model RuleEffectivenessSnapshot {
  id            String   @id @default(cuid())
  ruleId        String
  date          DateTime

  triggerCount  Int      // 触发次数
  falsePositive Int      // 误报次数
  fixedCount    Int      // 修复次数

  // 计算指标
  falsePositiveRate Float  // 误报率
  fixRate           Float  // 修复率
  valueScore        Float  // 价值分

  @@unique([ruleId, date])
  @@index([date])
}
```

---

## 技术实现要点

### 1. 数据聚合任务
```typescript
// 每日凌晨执行
@Cron('0 0 * * *')
async calculateDailySnapshots() {
  // 计算用户快照
  await this.calculateUserSnapshots();

  // 计算部门快照
  await this.calculateDepartmentSnapshots();

  // 计算公司快照
  await this.calculateCompanySnapshot();

  // 计算规则效能
  await this.calculateRuleEffectiveness();
}
```

### 2. 实时计算 + 缓存
```typescript
// 实时查询用户质量时
async getUserQuality(userId: string) {
  // 先查缓存
  const cached = await this.redis.get(`user:quality:${userId}`);
  if (cached) return JSON.parse(cached);

  // 计算并缓存
  const quality = await this.calculateUserQuality(userId);
  await this.redis.set(`user:quality:${userId}`, JSON.stringify(quality), 'EX', 3600);

  return quality;
}
```

### 3. 权限控制
```typescript
// 部门经理只能看本部门数据
async getDepartmentQuality(deptId: string, userId: string) {
  const user = await this.getUserWithPermissions(userId);

  // 检查权限
  if (user.role === 'DEPT_ADMIN' && user.departmentId !== deptId) {
    throw new ForbiddenException('无权查看其他部门数据');
  }

  return this.queryDepartmentQuality(deptId);
}
```

---

## 页面导航结构

```
顶部导航栏
├─ 我的中心（用户视角）
│  ├─ 我的质量画像
│  ├─ 我的项目
│  ├─ 我的问题
│  └─ 质量排行榜
│
├─ 部门管理（部门视角，仅Dept Admin可见）
│  ├─ 部门质量看板
│  ├─ 团队成员分析
│  ├─ 项目健康度
│  └─ 技能矩阵
│
├─ 全局看板（公司视角，仅Org Admin可见）
│  ├─ 公司质量总览
│  ├─ 部门对比
│  ├─ 高风险项目
│  ├─ 技术债务
│  └─ 目标追踪
│
├─ 规则中心（规则视角）
│  ├─ 规则效能分析
│  ├─ 规则管理
│  ├─ 规则市场
│  └─ A/B测试
│
└─ 对比分析（横向对比）
   ├─ 部门对比
   ├─ 项目对比
   ├─ 时间对比
   └─ 语言对比
```

---

## 优先级总结

| Epic | 优先级 | 预计工作量 | 备注 |
|------|--------|-----------|------|
| 用户视角 | P1 | 2周 | Story 11.1.1, 11.1.2 必须有 |
| 部门视角 | P1 | 2周 | Story 11.2.1, 11.2.2 必须有 |
| 公司视角 | P1 | 2周 | Story 11.3.1, 11.3.2 必须有 |
| 规则视角 | P1 | 1周 | Story 11.4.1 必须有 |
| 对比分析 | P1 | 1周 | Story 11.5.1 |
| 排行榜/游戏化 | P2 | 1周 | Story 11.1.3 |
| 高管报告 | P2 | 3天 | Story 11.3.3 |
| 规则A/B测试 | P2 | 1周 | Story 11.4.2 |

**总计**: 约8-10周工作量

---

这些多视角分析功能让平台从"审核工具"升级为"质量管理平台"，能够：
1. ✅ 激励开发者提升质量（个人画像、排行榜）
2. ✅ 帮助管理者做决策（部门、公司看板）
3. ✅ 优化平台本身（规则效能分析）
4. ✅ 提供数据支持（横向对比、报表导出）
